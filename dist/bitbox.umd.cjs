(function(a,c){typeof exports=="object"&&typeof module<"u"?c(exports):typeof define=="function"&&define.amd?define(["exports"],c):(a=typeof globalThis<"u"?globalThis:a||self,c(a.Bitbox={}))})(this,function(a){"use strict";var f=Object.defineProperty;var x=(a,c,u)=>c in a?f(a,c,{enumerable:!0,configurable:!0,writable:!0,value:u}):a[c]=u;var d=(a,c,u)=>(x(a,typeof c!="symbol"?c+"":c,u),u);class c{constructor(){d(this,"subscribers");this.subscribers={}}generateId(){return Math.random().toString(36).substring(2,9)}publish(e,...s){const t=this.subscribers[e];this.subscribers[e]&&Object.keys(t).forEach(r=>{t[r](...s)})}subscribe(e,s){const t=this.generateId();return this.subscribers[e]||(this.subscribers[e]={}),this.subscribers[e][t]=s,t}unsubscribe(e,s){var t;(t=this.subscribers[e])==null||delete t[s]}}var u=(n=>(n[n.IndexedDB=1]="IndexedDB",n[n.LocalStorage=2]="LocalStorage",n[n.SessionStorage=3]="SessionStorage",n))(u||{});const h=class h{constructor(e){d(this,"dbname","bitbox");d(this,"namespace");this.namespace=e}open(e){return new Promise((s,t)=>{const r=h.indexedDB.open(this.dbname,e);r.onerror=o=>{t(o)},r.onsuccess=()=>{s(r.result)},r.onupgradeneeded=o=>{const i=o.target.result,l=i.createObjectStore(this.namespace,{keyPath:"key"});l.transaction.oncomplete=()=>{s(i)}}})}get db(){return this.open().then(e=>(e.objectStoreNames||[]).contains(this.namespace)?e:this.open(e.version+1))}clear(){return new Promise(async(e,s)=>{const r=(await this.db).transaction([this.namespace],"readwrite").objectStore(this.namespace).clear();r.onsuccess=()=>{e()},r.onerror=o=>{s(o)}})}delete(e){return new Promise(async(s,t)=>{const o=(await this.db).transaction([this.namespace],"readwrite").objectStore(this.namespace).delete(e);o.onsuccess=()=>{s()},o.onerror=i=>{t(i)}})}destroy(){return new Promise(async(e,s)=>{const t=await this.open(),r=h.indexedDB.open(this.dbname,t.version+1);r.onerror=o=>{s(o)},r.onupgradeneeded=()=>{r.result.deleteObjectStore(this.namespace),e()}})}exists(e){return this.get(e).then(s=>!!s)}get(e){return new Promise(async(s,t)=>{const o=(await this.db).transaction(this.namespace,"readonly").objectStore(this.namespace).get(e);o.onsuccess=()=>{var i;s((i=o.result)==null?void 0:i.value)},o.onerror=i=>{t(i)}})}static get isSupported(){return!!this.indexedDB}get keys(){return new Promise(async(e,s)=>{const r=(await this.db).transaction(this.namespace,"readonly").objectStore(this.namespace).getAllKeys();r.onsuccess=()=>{e(r.result)},r.onerror=o=>{s(o)}})}set(e,s){return new Promise(async(t,r)=>{const i=(await this.db).transaction([this.namespace],"readwrite").objectStore(this.namespace).put({key:e,value:s});i.onsuccess=()=>{t()},i.onerror=l=>{r(l)}})}get size(){return new Promise(async(e,s)=>{const r=(await this.db).transaction(this.namespace,"readonly").objectStore(this.namespace).count();r.onsuccess=()=>{e(r.result)},r.onerror=o=>{s(o)}})}};d(h,"indexedDB",window.indexedDB||window.mozIndexedDB||window.webkitIndexedDB||window.msIndexedDB||window.shimIndexedDB);let b=h;class p{constructor(e,s){d(this,"namespace");d(this,"storage");this.namespace=e,this.storage=window[s]}clear(){return this.storage.clear(),Promise.resolve()}delete(e){return this.storage.removeItem(`${this.namespace}.${e}`),Promise.resolve()}destroy(){return this.clear(),Promise.resolve()}exists(e){return Promise.resolve(Object.keys(this.storage).includes(`${this.namespace}.${e}`))}get(e){const s=this.storage.getItem(`${this.namespace}.${e}`);return Promise.resolve(s&&JSON.parse(s))}get keys(){return Promise.resolve(Object.keys(this.storage).filter(e=>e.startsWith(`${this.namespace}.`)).map(e=>e.replace(`${this.namespace}.`,"")))}set(e,s){return this.storage.setItem(`${this.namespace}.${e}`,JSON.stringify(s)),Promise.resolve()}get size(){return Promise.resolve(Object.keys(this.storage).filter(e=>e.startsWith(`${this.namespace}.`)).length)}}class m extends p{constructor(e){super(e,"localStorage")}static get isSupported(){return!!window.localStorage}}class g extends p{constructor(e){super(e,"sessionStorage")}static get isSupported(){return!!window.sessionStorage}}class w{constructor(e,s=u.IndexedDB){d(this,"store");d(this,"namespace");switch(this.namespace=e,!0){case(s===u.IndexedDB&&b.isSupported):console.log("IndexedDB is supported"),this.store=new b(this.namespace);break;case(s===u.SessionStorage&&g.isSupported):console.log("SessionStorage is supported"),this.store=new g(this.namespace);break;case(s===u.LocalStorage&&m.isSupported):default:console.log("LocalStorage is supported"),this.store=new m(this.namespace);break}}clear(){return this.store.clear()}delete(e){return this.store.delete(e)}destroy(){return this.store.destroy()}get(e){return this.store.get(e)}exists(e){return this.store.exists(e)}get keys(){return this.store.keys}set(e,s){return this.store.set(e,s)}get size(){return this.store.size}}const S=n=>new Promise(e=>setTimeout(e,n));class y{constructor(e="default",s={}){d(this,"namespace");d(this,"options");d(this,"pubsub");d(this,"store");const t={immutable:!1,retry:!1,ttl:void 0,storage:u.IndexedDB};this.namespace=e,this.options=Object.assign({},t,s),this.pubsub=new c,this.store=new w(this.namespace,this.options.storage)}async clear(){const e=await this.store.keys;await this.store.clear(),e.forEach(s=>this.pubsub.publish(s,void 0))}async destroy(){await this.store.destroy()}async delete(e){await this.store.delete(e),this.pubsub.publish(e,void 0)}exists(e){return this.store.exists(e)}async get(e,s,t){let r=0,o,i;t=t||this.options.retry;do r>0&&await S(t.interval),{value:o,ttl:i}=await this.store.get(e)||{};while(!o&&t&&t.attempts>r++);if(i&&i<Date.now()){await this.delete(e);return}return!o&&s&&(o=typeof s=="function"?await Promise.resolve(s()):s),o}get keys(){return this.store.keys}async set(e,s,t){return t=t||this.options.ttl,this.options.immutable&&await this.exists(e)?Promise.reject("This Bitbox instance is immutable and cannot be set."):(this.store.set(e,{value:s,ttl:t&&Date.now()+t}),this.pubsub.publish(e,s),Promise.resolve())}get size(){return this.store.size}subscribe(e,s){return this.pubsub.subscribe(e,s)}unsubscribe(e,s){this.pubsub.unsubscribe(e,s)}}a.StorageType=u,a.default=y,Object.defineProperties(a,{__esModule:{value:!0},[Symbol.toStringTag]:{value:"Module"}})});
